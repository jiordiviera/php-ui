<?php

declare(strict_types=1);

namespace Jiordiviera\PhpUi\Core\Transformer;

use Illuminate\Filesystem\Filesystem;

class CssInjector
{
    protected Filesystem $files;

    public function __construct()
    {
        $this->files = new Filesystem;
    }

    public function injectVars(string $path, array $vars): void
    {
        if (! $this->files->exists($path)) {
            return;
        }

        $content = $this->files->get($path);

        // Find existing @theme block or create new one
        if (str_contains($content, '@theme {')) {
            // Insert variables into existing @theme block
            foreach ($vars as $name => $value) {
                if (! str_contains($content, $name)) {
                    $content = str_replace('@theme {', "@theme {\n  {$name}: {$value};", $content);
                }
            }
        } else {
            // Create new @theme block with all variables
            $varLines = [];
            foreach ($vars as $name => $value) {
                $varLines[] = "  {$name}: {$value};";
            }
            $content .= "\n@theme {\n".implode("\n", $varLines)."\n}\n";
        }

        $this->files->put($path, $content);
    }

    public function generateThemeVariables(string $baseColor, string $accentColor): array
    {
        return [
            // Primary colors based on accent selection
            '--color-primary' => "hsl(var(--color-{$accentColor}-600))",
            '--color-primary-foreground' => 'hsl(0 0% 98%)',
            '--color-primary-hover' => "hsl(var(--color-{$accentColor}-700))",
            '--color-primary-active' => "hsl(var(--color-{$accentColor}-800))",

            // Background colors based on base selection
            '--color-background' => "hsl(var(--color-{$baseColor}-50))",
            '--color-foreground' => "hsl(var(--color-{$baseColor}-900))",
            '--color-muted' => "hsl(var(--color-{$baseColor}-100))",
            '--color-muted-foreground' => "hsl(var(--color-{$baseColor}-500))",

            // Surface colors
            '--color-card' => "hsl(var(--color-{$baseColor}-50))",
            '--color-card-foreground' => "hsl(var(--color-{$baseColor}-900))",
            '--color-border' => "hsl(var(--color-{$baseColor}-200))",
            '--color-input' => "hsl(var(--color-{$baseColor}-50))",

            // Ring and radius
            '--color-ring' => "hsl(var(--color-{$accentColor}-500))",
            '--radius' => '0.5rem',
        ];
    }

    public function generateColorScale(string $color): array
    {
        // Generate complete color scales for all Tailwind v4 colors
        $scales = [
            'zinc' => [
                '50' => '0 0% 98%', '100' => '0 0% 96%', '200' => '0 0% 91%', '300' => '0 0% 88%',
                '400' => '0 0% 79%', '500' => '0 0% 64%', '600' => '0 0% 48%', '700' => '0 0% 32%',
                '800' => '0 0% 25%', '900' => '0 0% 15%', '950' => '0 0% 9%',
            ],
            'slate' => [
                '50' => '220 60% 98%', '100' => '220 13% 95%', '200' => '220 9% 90%', '300' => '220 8% 86%',
                '400' => '220 7% 81%', '500' => '220 9% 65%', '600' => '220 8% 46%', '700' => '220 10% 39%',
                '800' => '220 9% 30%', '900' => '220 10% 20%', '950' => '220 15% 10%',
            ],
            'stone' => [
                '50' => '60 9% 98%', '100' => '60 6% 93%', '200' => '20 5% 90%', '300' => '24 6% 83%',
                '400' => '24 7% 74%', '500' => '24 9% 55%', '600' => '24 10% 40%', '700' => '24 12% 31%',
                '800' => '24 13% 23%', '900' => '24 15% 17%', '950' => '24 19% 10%',
            ],
            'gray' => [
                '50' => '0 0% 98%', '100' => '0 0% 97%', '200' => '0 0% 89%', '300' => '0 0% 79%',
                '400' => '0 0% 70%', '500' => '0 0% 56%', '600' => '0 0% 45%', '700' => '0 0% 33%',
                '800' => '0 0% 26%', '900' => '0 0% 21%', '950' => '0 0% 11%',
            ],
            'neutral' => [
                '50' => '0 0% 98%', '100' => '0 0% 97%', '200' => '0 0% 89%', '300' => '0 0% 77%',
                '400' => '0 0% 68%', '500' => '0 0% 54%', '600' => '0 0% 39%', '700' => '0 0% 32%',
                '800' => '0 0% 25%', '900' => '0 0% 20%', '950' => '0 0% 9%',
            ],
            'red' => [
                '50' => '0 85% 97%', '100' => '0 93% 94%', '200' => '0 96% 91%', '300' => '0 95% 84%',
                '400' => '0 91% 78%', '500' => '0 84% 67%', '600' => '0 72% 51%', '700' => '0 66% 42%',
                '800' => '0 64% 35%', '900' => '0 63% 30%', '950' => '0 64% 24%',
            ],
            'rose' => [
                '50' => '0 93% 94%', '100' => '0 88% 91%', '200' => '0 83% 88%', '300' => '0 78% 84%',
                '400' => '0 71% 77%', '500' => '0 63% 68%', '600' => '0 74% 51%', '700' => '0 60% 41%',
                '800' => '0 48% 33%', '900' => '0 39% 26%', '950' => '0 24% 17%',
            ],
            'orange' => [
                '50' => '0 100% 97%', '100' => '0 100% 93%', '200' => '0 100% 88%', '300' => '0 100% 78%',
                '400' => '0 100% 65%', '500' => '0 95% 53%', '600' => '0 91% 40%', '700' => '0 88% 29%',
                '800' => '0 84% 22%', '900' => '0 69% 15%', '950' => '0 43% 9%',
            ],
            'amber' => [
                '50' => '60 100% 98%', '100' => '60 100% 95%', '200' => '60 100% 90%', '300' => '60 100% 81%',
                '400' => '60 100% 69%', '500' => '60 100% 57%', '600' => '60 88% 42%', '700' => '60 71% 28%',
                '800' => '60 56% 20%', '900' => '60 41% 13%', '950' => '60 26% 7%',
            ],
            'yellow' => [
                '50' => '60 100% 98%', '100' => '60 100% 96%', '200' => '60 100% 92%', '300' => '60 100% 84%',
                '400' => '60 100% 76%', '500' => '60 100% 61%', '600' => '60 77% 47%', '700' => '60 61% 33%',
                '800' => '60 48% 24%', '900' => '60 36% 17%', '950' => '60 20% 8%',
            ],
            'lime' => [
                '50' => '84 100% 97%', '100' => '84 100% 95%', '200' => '84 100% 90%', '300' => '84 100% 81%',
                '400' => '84 100% 70%', '500' => '84 81% 55%', '600' => '84 71% 43%', '700' => '84 61% 30%',
                '800' => '84 48% 20%', '900' => '84 36% 15%', '950' => '84 22% 8%',
            ],
            'green' => [
                '50' => '140 76% 97%', '100' => '140 71% 94%', '200' => '140 69% 88%', '300' => '140 68% 81%',
                '400' => '140 61% 71%', '500' => '140 62% 56%', '600' => '140 63% 42%', '700' => '140 55% 31%',
                '800' => '140 44% 23%', '900' => '140 35% 17%', '950' => '140 25% 9%',
            ],
            'emerald' => [
                '50' => '160 76% 97%', '100' => '160 71% 94%', '200' => '160 61% 88%', '300' => '160 54% 81%',
                '400' => '160 44% 71%', '500' => '160 51% 55%', '600' => '160 48% 42%', '700' => '160 41% 29%',
                '800' => '160 32% 22%', '900' => '160 25% 16%', '950' => '160 16% 9%',
            ],
            'teal' => [
                '50' => '168 76% 97%', '100' => '168 71% 94%', '200' => '168 64% 89%', '300' => '168 62% 82%',
                '400' => '168 52% 71%', '500' => '168 54% 55%', '600' => '168 49% 42%', '700' => '168 40% 30%',
                '800' => '168 31% 22%', '900' => '168 24% 16%', '950' => '168 15% 9%',
            ],
            'cyan' => [
                '50' => '188 100% 97%', '100' => '186 100% 94%', '200' => '185 100% 89%', '300' => '183 100% 80%',
                '400' => '181 100% 68%', '500' => '181 87% 55%', '600' => '182 84% 41%', '700' => '183 77% 27%',
                '800' => '183 68% 21%', '900' => '183 55% 15%', '950' => '183 41% 8%',
            ],
            'sky' => [
                '50' => '196 93% 97%', '100' => '196 83% 94%', '200' => '196 71% 89%', '300' => '196 65% 81%',
                '400' => '196 54% 70%', '500' => '196 65% 55%', '600' => '196 58% 42%', '700' => '196 49% 30%',
                '800' => '196 41% 22%', '900' => '196 31% 16%', '950' => '196 21% 9%',
            ],
            'blue' => [
                '50' => '220 90% 97%', '100' => '214 95% 94%', '200' => '213 96% 91%', '300' => '211 96% 84%',
                '400' => '213 94% 68%', '500' => '221 83% 53%', '600' => '217 91% 60%', '700' => '215 96% 61%',
                '800' => '216 94% 46%', '900' => '222 84% 37%', '950' => '220 90% 28%',
            ],
            'indigo' => [
                '50' => '238 100% 97%', '100' => '236 100% 94%', '200' => '234 100% 88%', '300' => '231 100% 80%',
                '400' => '227 100% 68%', '500' => '231 76% 55%', '600' => '229 84% 43%', '700' => '227 71% 30%',
                '800' => '225 63% 22%', '900' => '223 47% 16%', '950' => '220 41% 9%',
            ],
            'violet' => [
                '50' => '250 100% 97%', '100' => '250 96% 94%', '200' => '250 95% 88%', '300' => '250 94% 81%',
                '400' => '250 91% 68%', '500' => '250 84% 55%', '600' => '250 77% 43%', '700' => '250 61% 30%',
                '800' => '250 48% 22%', '900' => '250 39% 16%', '950' => '250 33% 9%',
            ],
            'purple' => [
                '50' => '270 100% 97%', '100' => '270 100% 95%', '200' => '270 100% 89%', '300' => '270 100% 81%',
                '400' => '270 100% 69%', '500' => '270 89% 55%', '600' => '270 81% 43%', '700' => '270 61% 30%',
                '800' => '270 47% 22%', '900' => '270 37% 16%', '950' => '270 28% 9%',
            ],
            'fuchsia' => [
                '50' => '300 100% 97%', '100' => '300 100% 94%', '200' => '300 100% 88%', '300' => '300 100% 80%',
                '400' => '300 100% 68%', '500' => '300 100% 55%', '600' => '300 96% 43%', '700' => '300 88% 30%',
                '800' => '300 73% 22%', '900' => '300 57% 16%', '950' => '300 42% 9%',
            ],
            'pink' => [
                '50' => '330 100% 97%', '100' => '330 100% 94%', '200' => '330 100% 88%', '300' => '330 100% 81%',
                '400' => '330 100% 69%', '500' => '330 94% 55%', '600' => '330 83% 43%', '700' => '330 71% 30%',
                '800' => '330 59% 22%', '900' => '330 46% 16%', '950' => '330 34% 9%',
            ],
        ];

        return $scales[$color] ?? $scales['blue'];
    }

    public function injectCompleteColorScale(string $path, string $baseColor, string $accentColor): void
    {
        if (! $this->files->exists($path)) {
            return;
        }

        $content = $this->files->get($path);

        // Remove existing @theme block if present
        $content = preg_replace('/@theme\s*\{[^}]*\}/', '', $content);

        // Generate all color variables for base and accent
        $baseScale = $this->generateColorScale($baseColor);
        $accentScale = $this->generateColorScale($accentColor);

        $allColors = array_merge($baseScale, $accentScale);
        $colorVars = [];

        foreach ($allColors as $colorName => $shades) {
            if (! is_array($shades)) {
                continue;
            }

            foreach ($shades as $shade => $hsl) {
                $varName = "--color-{$colorName}-{$shade}";
                $colorVars[] = "  {$varName}: {$hsl};";
            }
        }

        // Add new @theme block with all colors
        $themeBlock = "@theme {\n".implode("\n", $colorVars)."\n}";

        // Add at end of file
        $content .= "\n".$themeBlock."\n";

        $this->files->put($path, $content);
    }
}
